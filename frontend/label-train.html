<!DOCTYPE html>
<html>
    <head>
        <title>CBASv2/Label</title>

        <script type="text/javascript" src="/eel.js"></script>

        <link rel="stylesheet" href="index.css">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    </head>

    <body class="bg-secondary">
        <script type="text/javascript" src="/eel.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  
        <nav class="navbar navbar-expand-sm navbar-dark bg-tertiary" style="padding-bottom:50px">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">CBASv2</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <button class="nav-link" onclick="routeRecord()">Record</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link text-white" onclick="routeLabelTrain()">Label/Train</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>



        <div class="modal" tabindex="-1" id="addDataset">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Create Dataset</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Name: </p>
                  <input type="text" class="form-control" id="dataset-name" aria-describedby="directory" placeholder="e.g. dataset1" style="margin-bottom: 10px">
                  <p>Behaviors: </p>
                  <input type="text" class="form-control" id="dataset-behaviors" aria-describedby="directory" placeholder="e.g. eating; drinking; background" style="margin-bottom: 10px">

                  <p>Directories to label: </p>
                  <div id="recording_tree">
                  </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" onclick="createDataset()">Create</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal" tabindex="-1" id="errorModal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Error!</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p id="error-message"></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>


        <div id="datasets" style="display: block;">
            <div class="container align-items-center justify-content-center">
                <div class="col" id="dataset-container">
                    
                </div>
            </div>

            <div class="fab-container">
                <div class="fab shadow">
                    <div class="fab-content" onclick="showDatasetModal()">
                        <i class="bi bi-plus-lg" style="color:white; font-size:50px;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex col align-items-center justify-content-center" style="height: max-content; width: 100vw;">

            <div class="card text-start"  id="label"  style="height: 800px; width: 95vw; min-width: 750px; display: none;background-color: #343a40;">

                <div class="card-body d-flex col align-items-center justify-content-center" style="padding: 20px;">
                    <div class="container-fluid">
                        <div class="row" style="padding-bottom: 10px;">
                            <div class="col">
                                <div id="img-section">
                                    <img id="label-image" src="" alt="" style="border:2px solid black;">
                                </div>
                            </div>
                            <div class="col">
                                <div id="controls" style="min-width: 156px; width: 20vw; height: 520px;">

                                </div>
                            </div>
        
                        </div>
                        <div class="row" style="height: 200px; width:710px; background-color: #adb5bd;">
                            <div id="scoreboard">


                            </div>
                        </div>
        
                    </div>
                    <div id="controls">
        
                    </div>
            
                </div>
            </div>
            
        </div>
          

        <script type="text/javascript">
          
          const ipc = window.ipcRendere


          let loaded = false
          let routing = false

          let labeling = false
          
          let datasetModal = new bootstrap.Modal(document.getElementById('addDataset'))

          let dir_children = new Object();

          let surf = 1;

          function read(attr) {
              let project_string = window.localStorage.getItem('project')
              let project = JSON.parse(project_string)
              return project[attr]
          }

          function routeRecord() {
              routing = true 
              window.open('./record.html', '_self');
          }
          function routeLabelTrain() {
              routing = true 
              window.open('./label-train.html', '_self');
          }
            
          function load_initial() {
              eel.datasets(read('data_sets'))().then( function(data) {


                let container = document.getElementById('dataset-container')

                container.innerHTML = ""

                let names = Object.keys(data)
                let sets = data

                for (i = 0; i < names.length; i++) {
                    let n = names[i]
                    let name = sets[n]['name']

                    let behaviors = sets[n]['behaviors']
                    
                    let metrics = sets[n]['metrics']

                    let mheaders = ['Train #', 'Test #', 'Precision','Recall', 'F1 Score']

                    let html = `
                    <div class="row-auto"  style="padding:15px">
                        <div class="card shadow text-light bg-light" style="width: 700px; height:max-content;">
                            <div class="card-header bg-dark">
                                <h1 class="display-6">` + name +`</h1>
                                <button class="btn btn-outline-primary position-absolute top-0 end-0" style='width:80px;margin-right:15px;margin-top:15px' type="submit" onclick="labelModal('`+name+`')">Label</button>
                            </div>
                    ` 

                    for(b=0;b<behaviors.length;b++) {

                      if(b==0) {
                        html += `
                            <div class="container" style='padding-top:10px'>
                              <div class="row">
                                <div class="col h5 text-dark">
                                  Behavior
                                </div>
                                <div class="col h5 text-dark">
                                  `+mheaders[0]+`
                                </div>
                                <div class="col h5 text-dark">
                                  `+mheaders[1]+`
                                </div>
                                <div class="col h5 text-dark">
                                  `+mheaders[2]+`
                                </div>
                                <div class="col h5 text-dark">
                                  `+mheaders[3]+`
                                </div>
                                <div class="col h5 text-dark">
                                  `+mheaders[4]+`
                                </div>
                              </div>
                            </div>
                      `
                      }

                      html += `
                            <div class="container" style='padding-top:10px'>
                              <div class="row">
                                <div class="col h6 text-dark">
                                  `+behaviors[b]+`
                                </div>
                                <div class="col h6 text-dark">
                                  `+metrics[behaviors[b]][mheaders[0]]+`
                                </div>
                                <div class="col h6 text-dark">
                                  `+metrics[behaviors[b]][mheaders[1]]+`
                                </div>
                                <div class="col h6 text-dark">
                                    `+metrics[behaviors[b]][mheaders[2]]+`
                                </div>
                                <div class="col h6 text-dark">
                                  `+metrics[behaviors[b]][mheaders[3]]+`
                                </div>
                                <div class="col h6 text-dark">
                                  `+metrics[behaviors[b]][mheaders[4]]+`
                                </div>
                              </div>
                            </div>
                      `
                    }
                    
                    html += `
                        </div>
                    </div>`

                    container.innerHTML += html

                }

                  
              })
          }

          eel.expose(updateLabelImageSrc);
          function updateLabelImageSrc(val) {
              console.log(val)
              let elem = document.getElementById('label-image');
              elem.src = "data:image/jpeg;base64, " + val
          }

          function labelModal(name) {

            eel.start_labeling(read('data_sets'), name)(function (res){
              if(res) {
                  labeling = true 

                  let controls = document.getElementById('controls')

                  behaviors = res[0]
                  colors = res[1]

                  for(i=0;i<20-behaviors.length;i++) {
                    behaviors.push('behavior '+i+"")
                  }

                  for(i=0;i<behaviors.length;i++) {

                    let k = i

                    if(i>9){
                        k = String.fromCharCode(97+i-9)
                    }

                    controls.innerHTML += `
                            <div class="row">
                                <div class="col h6 text-light">
                                    `+behaviors[i]+`
                                </div>
                                <div class="col h6 text-center" style="background-color:`+colors[i]+`;">
                                    `+k+`
                                </div>
                            </div>
                                `
                  }

                  document.getElementById('datasets').style.display = 'none'
                  document.getElementById('label').style.display = 'flex'

              } else {
                  document.getElementById('error-message').innerText = 'Error opening videos in this dataset.'
                  let errorModal = new bootstrap.Modal(document.getElementById('errorModal'))
                  errorModal.show()
              }
            })

        
          }

          function createDataset() {

              let dirs = Object.keys(dir_children)

              if(dirs.length==0) {
                  document.getElementById('error-message').innerText = 'No recordings selected, try again.'
                  let errorModal = new bootstrap.Modal(document.getElementById('errorModal'))
                  errorModal.show()
                  return
              }

              let recordings = []

              for(i=0;i<dirs.length;i++) {
                let elem = document.getElementById(dirs[i])

                if(elem.checked) {
                  recordings.push(dirs[i])
                  continue
                } 

                let subdirs = dir_children[dirs[i]]

                for(j=0;j<subdirs.length;j++) {
                  let elem = document.getElementById(dirs[i]+'-'+subdirs[j])

                  if(elem.checked) {
                    recordings.push(dirs[i]+'\\'+subdirs[j])
                  } 
                }
              }

              let name = document.getElementById('dataset-name').value
              let behaviors = document.getElementById('dataset-behaviors').value

              let behavior_array = behaviors.split(';')

              if(behavior_array.length<=1 || behavior_array.length>20) {
                  document.getElementById('error-message').innerText = 'Must have between two to twenty behaviors specified, try again.'
                  let errorModal = new bootstrap.Modal(document.getElementById('errorModal'))
                  errorModal.show()
                  return
              }

              let ba = []
              for(i=0;i<behavior_array.length;i++) {
                ba.push(behavior_array[i].trim())
              }



              eel.create_dataset(read('data_sets'), name, ba, recordings)(function (ret){
                if(!ret) {
                  document.getElementById('error-message').innerText = 'Unable to create the dataset.'
                  let errorModal = new bootstrap.Modal(document.getElementById('errorModal'))
                  errorModal.show()
                  return
                }
              })

              datasetModal.hide()
              datasetModal = new bootstrap.Modal(document.getElementById('addDataset'))

              load_initial()
          }

          window.addEventListener("unload", function(e){
              if(!routing) {
                  eel.kill_streams();
              }
          });

          window.onbeforeunload = function (){
              if(!routing) {
                  eel.kill_streams();
              }
          }

          function updateChildren(dir) {
            let subdirs = dir_children[dir]
            let parent = document.getElementById(dir)

            if(subdirs.length>0) {
              for(i=0;i<subdirs.length;i++) {
                let child = document.getElementById(dir+'-'+subdirs[i])
                child.checked = parent.checked
              }
            }
          }

          function showDatasetModal() {

              eel.get_record_tree()(function (rt){

                if(rt) {
                  let elem = document.getElementById('recording_tree')

                  dir_children = new Object()

                  elem.innerHTML = ''

                  let dirs = Object.keys(rt)

                  for(i=0;i<dirs.length;i++) {
                    subdirs = rt[dirs[i]]

                    dir_children[dirs[i]] = subdirs

                    elem.innerHTML += `
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="`+dirs[i]+`" onChange="updateChildren(`+dirs[i]+`)">
                      <label class="form-check-label" for="flexCheckDefault">
                        `+ dirs[i] +`
                      </label>
                    </div>
                    `
                    for(j=0;j<subdirs.length;j++) {
                      elem.innerHTML += `
                      <div class="form-check" style='margin-left:10px'>
                        <input class="form-check-input" type="checkbox" value="" id="`+dirs[i]+`-`+subdirs[i]+`">
                        <label class="form-check-label" for="flexCheckDefault">
                          `+ subdirs[j] +`
                        </label>
                      </div>
                      `
                    }

                  }

                  datasetModal.show()
                } else {
                  document.getElementById('error-message').innerText = 'No recordings yet, try this again when you have recorded videos.'
                  let errorModal = new bootstrap.Modal(document.getElementById('errorModal'))
                  errorModal.show()
                }

              })
              
          }

          window.addEventListener("keydown", (event) => {

            if(labeling) {
                switch (event.key) {
                    case "ArrowLeft":
                        eel.nextFrame(-surf);
                        break;
                    case "ArrowRight":
                        eel.nextFrame(surf);
                        break;
                    case "ArrowUp":
                        surf = surf*2;
                        break;
                    case "ArrowDown":
                        if(surf!=1) {
                            surf = Math.trunc(surf/2)
                        }
                        break;

                    default:
                        if(event.keyCode>=49 && event.keyCode<=57) {
                            eel.label_frame(event.keyCode-49)
                        } else if(event.keyCode>=65 && event.keyCode<=90) {
                            eel.label_frame(event.keyCode-65+9)    
                        }
                        break;
                }

            }

          })

            window.setInterval(function(){
                load_initial()
            }, 10000)

            window.setTimeout(function(){
                load_initial()
            }, 1000)

        </script>

    </body>
</html>